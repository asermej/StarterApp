<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.3.xsd">

    <changeSet id="20251110000000-fix-persona-display-name-unique-constraint" author="liquibase">
        <!-- Drop the existing unique constraint on display_name -->
        <dropUniqueConstraint 
            tableName="personas" 
            constraintName="personas_display_name_key"/>
        
        <!-- Create a partial unique index that only applies to non-deleted records -->
        <!-- This allows the same display_name to be reused after a persona is soft-deleted -->
        <sql>
            CREATE UNIQUE INDEX personas_display_name_active_key 
            ON personas (display_name) 
            WHERE is_deleted = false;
        </sql>
        
        <rollback>
            <!-- Drop the partial unique index -->
            <sql>DROP INDEX IF EXISTS personas_display_name_active_key;</sql>
            
            <!-- Recreate the original unique constraint (note: this may fail if there are duplicate deleted records) -->
            <addUniqueConstraint 
                tableName="personas" 
                columnNames="display_name" 
                constraintName="personas_display_name_key"/>
        </rollback>
    </changeSet>
</databaseChangeLog>

